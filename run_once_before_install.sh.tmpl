#!/bin/bash
set -euo pipefail

# --- Install zsh if not present ---
if ! command -v zsh &>/dev/null; then
  echo "==> Installing zsh..."
{{- if eq .chezmoi.os "darwin" }}
  brew install zsh
{{- else if eq .chezmoi.osRelease.id "arch" }}
  sudo pacman -S --noconfirm zsh
{{- else }}
  sudo apt update && sudo apt install -y zsh
{{- end }}
fi

# --- Set zsh as default shell ---
if [ "$SHELL" != "$(which zsh)" ]; then
  echo "==> Setting zsh as default shell..."
  chsh -s "$(which zsh)"
fi

# --- Install Ansible if not present ---
if ! command -v ansible-playbook &>/dev/null; then
  echo "==> Installing Ansible..."
{{- if eq .chezmoi.os "darwin" }}
  brew install ansible
{{- else if eq .chezmoi.osRelease.id "arch" }}
  sudo pacman -S --noconfirm ansible
{{- else }}
  sudo apt update && sudo apt install -y ansible
{{- end }}
fi

# --- Run the Ansible playbook ---
echo "==> Running Ansible playbook..."
ansible-playbook "{{ .chezmoi.sourceDir }}/.setup/ansible/playbook.yml" --ask-become-pass

echo "==> Setup complete."
