#!/bin/bash
set -euo pipefail

{{ if eq .chezmoi.os "darwin" -}}
# --- Install Homebrew if not present ---
if ! command -v brew &>/dev/null; then
  echo "==> Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi
{{ end -}}

{{ if eq .chezmoi.os "darwin" -}}
# --- Enable Touch ID for sudo ---
PAM_SUDO="/etc/pam.d/sudo_local"
if [ ! -f "$PAM_SUDO" ] || ! grep -q pam_tid "$PAM_SUDO"; then
  echo "==> Enabling Touch ID for sudo..."
  sudo sh -c 'echo "auth       sufficient     pam_tid.so" > /etc/pam.d/sudo_local'
fi
{{ end -}}

# --- Install zsh if not present ---
if ! command -v zsh &>/dev/null; then
  echo "==> Installing zsh..."
{{- if eq .chezmoi.os "darwin" }}
  brew install zsh
{{- else if eq .chezmoi.osRelease.id "arch" }}
  sudo pacman -S --noconfirm zsh
{{- else }}
  sudo apt update && sudo apt install -y zsh
{{- end }}
fi

# --- Set zsh as default shell ---
if [ "$SHELL" != "$(which zsh)" ]; then
  echo "==> Setting zsh as default shell..."
  sudo chsh -s "$(which zsh)" "$USER"
fi

# --- Install Ansible if not present ---
if ! command -v ansible-playbook &>/dev/null; then
  echo "==> Installing Ansible..."
{{- if eq .chezmoi.os "darwin" }}
  brew install ansible
{{- else if eq .chezmoi.osRelease.id "arch" }}
  sudo pacman -S --noconfirm ansible
{{- else }}
  sudo apt update && sudo apt install -y ansible
{{- end }}
fi

# --- Run the Ansible playbook ---
echo "==> Running Ansible playbook..."
ansible-playbook "{{ .chezmoi.sourceDir }}/.setup/ansible/playbook.yml" --ask-become-pass

echo "==> Setup complete. Restart your shell or run: exec zsh"
