#!/bin/bash
set -euo pipefail

# --- Prompt for password once, reuse everywhere ---
read -rsp "==> Enter your sudo password (one-time prompt): " SUDO_PASS
echo
echo "$SUDO_PASS" | sudo -S -v 2>/dev/null
# Keep sudo alive in the background for the duration of the script
while true; do echo "$SUDO_PASS" | sudo -S -n true 2>/dev/null; sleep 30; done &
SUDO_PID=$!
trap 'kill $SUDO_PID 2>/dev/null' EXIT
export ANSIBLE_BECOME_PASSWORD="$SUDO_PASS"

{{ if eq .chezmoi.os "darwin" -}}
# --- Install Homebrew if not present ---
if ! command -v brew &>/dev/null; then
  echo "==> Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi
{{ end -}}

# --- Install zsh if not present ---
if ! command -v zsh &>/dev/null; then
  echo "==> Installing zsh..."
{{- if eq .chezmoi.os "darwin" }}
  brew install zsh
{{- else if eq .chezmoi.osRelease.id "arch" }}
  sudo pacman -S --noconfirm zsh
{{- else }}
  sudo apt update && sudo apt install -y zsh
{{- end }}
fi

# --- Set zsh as default shell ---
if [ "$SHELL" != "$(which zsh)" ]; then
  echo "==> Setting zsh as default shell..."
  sudo chsh -s "$(which zsh)" "$USER"
fi

# --- Install Ansible if not present ---
if ! command -v ansible-playbook &>/dev/null; then
  echo "==> Installing Ansible..."
{{- if eq .chezmoi.os "darwin" }}
  brew install ansible
{{- else if eq .chezmoi.osRelease.id "arch" }}
  sudo pacman -S --noconfirm ansible
{{- else }}
  sudo apt update && sudo apt install -y ansible
{{- end }}
fi

# --- Run the Ansible playbook ---
echo "==> Running Ansible playbook..."
ansible-playbook "{{ .chezmoi.sourceDir }}/.setup/ansible/playbook.yml"

echo "==> Setup complete. Restart your shell or run: exec zsh"
